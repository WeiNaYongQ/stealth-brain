<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Calculator</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;}
body,html{height:100%;background:#000;color:#fff;font-family:sans-serif;overflow:hidden;}
#calculator{display:flex;flex-direction:column;height:100%;padding:20px 0 0;}
#display{padding:0 20px 20px;text-align:right;font-size:80px;min-height:120px;display:flex;align-items:flex-end;justify-content:flex-end;overflow:hidden;white-space:nowrap;}
#buttons{display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(5,1fr);gap:16px;padding:0 16px 24px;flex:1;}
.btn{background:#333;border-radius:50%;font-size:32px;display:flex;align-items:center;justify-content:center;color:#fff;border:none;cursor:pointer;}
.btn:active{background:#444;}
.btn.operator{background:#f1a33c;}
.btn.operator:active{background:#d99234;}
.btn.zero{grid-column:span 2;border-radius:36px;}
#chessLayer{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;opacity:0;pointer-events:none;}
</style>
</head>
<body>
<div id="calculator">
<div id="display">0</div>
<div id="buttons">
<button class="btn clear" data-value="C">C</button>
<button class="btn" data-value="±">±</button>
<button class="btn" data-value="%">%</button>
<button class="btn operator" data-value="/">÷</button>
<button class="btn" data-value="7">7</button>
<button class="btn" data-value="8">8</button>
<button class="btn" data-value="9">9</button>
<button class="btn operator" data-value="*">×</button>
<button class="btn" data-value="4">4</button>
<button class="btn" data-value="5">5</button>
<button class="btn" data-value="6">6</button>
<button class="btn operator" data-value="-">−</button>
<button class="btn" data-value="1">1</button>
<button class="btn" data-value="2">2</button>
<button class="btn" data-value="3">3</button>
<button class="btn operator" data-value="+">+</button>
<button class="btn zero" data-value="0">0</button>
<button class="btn" data-value=".">.</button>
<button class="btn" data-value="=">=</button>
</div>
</div>
<div id="chessLayer"></div>
<script src="https://cdn.jsdelivr.net/npm/chess.js@0.10.3/chess.min.js"></script>
<script>
let mode = 'calculator';
let currentLetter = 0;
let currentNumber = 1;
let fromSquare = null;
let game = new Chess();
let lastBestMove = null;
let moveHistory = [];

const calcEl = document.getElementById('calculator');
const chessEl = document.getElementById('chessLayer');
const display = document.getElementById('display');

// ✅ Vibration
const vibrate = (ms) => {
  if (navigator.vibrate) navigator.vibrate(ms);
};

// ✅ SPEECH THAT WORKS ON MOBILE
const speak = (text) => {
  if (!speechSynthesis) return;
  speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = 1.3;   // Clearer than 2.0
  utterance.volume = 1.0; // Max volume
  utterance.lang = 'en-US';
  speechSynthesis.speak(utterance);
};

// ✅ Switch to Chess
const switchToChess = (color) => {
  mode = 'chess';
  calcEl.style.display = 'none';
  chessEl.style.opacity = '1';
  chessEl.style.pointerEvents = 'auto';
  game = new Chess();
  moveHistory = [];
  lastBestMove = null;
  resetInputCycle();
  if (color === 'black') {
    setTimeout(fetchBestMove, 500);
  } else {
    speak("White to move");
  }
};

const switchToCalculator = () => {
  mode = 'calculator';
  calcEl.style.display = 'flex';
  chessEl.style.opacity = '0';
  chessEl.style.pointerEvents = 'none';
  speechSynthesis.cancel();
  currentInput = '0';
  operatorPressed = false;
  updateDisplay();
};

const resetInputCycle = () => {
  currentLetter = 0;
  currentNumber = 1;
};

// ✅ STRONG, WORKING ENGINE
const fetchBestMove = async () => {
  speak("Thinking");
  try {
    const res = await fetch('https://chess.swehosting.se/api/v1/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fen: game.fen(), depth: 15 })
    });
    if (res.ok) {
      const data = await res.json();
      const bestMove = data.bestmove;
      if (bestMove && bestMove.length === 4) {
        const from = bestMove.slice(0, 2);
        const to = bestMove.slice(2, 4);
        const move = game.move({ from, to, promotion: 'q' });
        if (move) {
          lastBestMove = { from, to };
          speak(`Opponent ${from} to ${to}`);
          vibrate(50);
          resetInputCycle();
          return;
        }
      }
    }
  } catch (e) {}
  // Fallback
  const moves = game.moves({ verbose: true });
  if (moves.length > 0) {
    const move = moves[0];
    game.move(move);
    lastBestMove = { from: move.from, to: move.to };
    speak(`Opponent ${move.from} to ${move.to}`);
    vibrate(50);
    resetInputCycle();
  }
};

// ✅ TOUCH HANDLING — GUARANTEED SPEECH
let longPressTimer = null;
const LONG_PRESS = 1200;

chessEl.addEventListener('touchstart', (e) => {
  if (mode !== 'chess') return;
  e.preventDefault();
  const y = e.touches[0].clientY;
  const isUpper = y < window.innerHeight / 2;

  // Clear any pending long-press
  if (longPressTimer) clearTimeout(longPressTimer);

  // Start long-press timer
  longPressTimer = setTimeout(() => {
    if (isUpper) {
      // Long-hold Upper: Undo
      if (moveHistory.length > 0) {
        moveHistory.pop();
        if (moveHistory.length > 0) moveHistory.pop(); // undo pair
        const last = moveHistory[moveHistory.length - 1];
        game = new Chess(last ? last.fen : 'start');
        speak("Undone");
        vibrate(50);
        resetInputCycle();
      } else {
        speak("No move");
      }
    } else {
      // Long-hold Lower: Replay best move
      if (lastBestMove) {
        speak(`Best move: ${lastBestMove.from} to ${lastBestMove.to}`);
      } else {
        speak("No move");
      }
    }
  }, LONG_PRESS);

  // IMMEDIATE TAP FEEDBACK
  if (isUpper) {
    speak(currentNumber.toString());
    vibrate(10);
    currentNumber = currentNumber % 8 + 1;
  } else {
    speak(String.fromCharCode(97 + currentLetter));
    vibrate(10);
    currentLetter = (currentLetter + 1) % 8;
  }
});

chessEl.addEventListener('touchend', (e) => {
  if (mode !== 'chess') return;
  e.preventDefault();
  if (longPressTimer) {
    clearTimeout(longPressTimer);
    longPressTimer = null;

    const y = e.changedTouches[0].clientY;
    const isUpper = y < window.innerHeight / 2;

    if (isUpper) {
      // Short-hold Upper: Confirm move
      if (fromSquare) {
        const toSq = String.fromCharCode(97 + currentLetter) + currentNumber;
        const move = game.move({ from: fromSquare, to: toSq, promotion: 'q' });
        if (move) {
          moveHistory.push({ fen: game.fen() });
          speak(`To ${toSq}`);
          vibrate(50);
          fromSquare = null;
          resetInputCycle();
          if (game.turn() === 'b') setTimeout(fetchBestMove, 300);
        } else {
          speak("Invalid");
          vibrate(10);
        }
      } else {
        speak("No from");
        vibrate(10);
      }
    } else {
      // Short-hold Lower: Set "From"
      fromSquare = String.fromCharCode(97 + currentLetter) + currentNumber;
      speak(`From ${fromSquare}`);
      vibrate(50);
      resetInputCycle();
    }
  }
});

// ✅ CALCULATOR
let currentInput = '0';
let operatorPressed = false;
const updateDisplay = () => {
  display.textContent = currentInput.length > 12 ? parseFloat(currentInput).toExponential(5) : currentInput;
};
const handleButton = (v) => {
  if (v === 'C') { currentInput = '0'; operatorPressed = false; updateDisplay(); return; }
  if (v === '±') { if (currentInput !== '0') currentInput = currentInput.startsWith('-') ? currentInput.slice(1) : '-' + currentInput; updateDisplay(); return; }
  if (v === '%') { const n = parseFloat(currentInput); if (!isNaN(n)) currentInput = (n/100).toString(); updateDisplay(); return; }
  if (v === '=') {
    if (currentInput === '666') { switchToChess('white'); return; }
    if (currentInput === '999') { switchToChess('black'); return; }
    try { let r = Function('"use strict";return('+currentInput+')')(); currentInput = isNaN(r)||!isFinite(r)?'Error':parseFloat(r.toFixed(10)).toString(); }
    catch(e) { currentInput = 'Error'; } operatorPressed = true; updateDisplay(); return;
  }
  if (['+','-','*','/'].includes(v)) {
    if (operatorPressed && ['+','-','*','/'].includes(currentInput.slice(-1))) currentInput = currentInput.slice(0,-1) + v;
    else currentInput += v; operatorPressed = true; updateDisplay(); return;
  }
  if (operatorPressed || currentInput === '0') { currentInput = v==='.'?'0.':v; operatorPressed = false; }
  else { if (v === '.') { if (!currentInput.includes('.')) currentInput += '.'; } else currentInput += v; }
  updateDisplay();
};
document.querySelectorAll('.btn').forEach(btn => btn.addEventListener('click', () => handleButton(btn.dataset.value)));
updateDisplay();
</script>
</body>
</html>
