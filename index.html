<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculator</title> <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        /* PRO STYLING: High Contrast, Battery Saver, Stealth */
        body { margin: 0; background: #000; height: 100vh; overflow: hidden; touch-action: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        /* CHESS UI - Invisible Layer */
        #c-layer { display: flex; flex-direction: column; height: 100%; width: 100%; position: absolute; z-index: 10; opacity: 0.01; } 
        .zone { flex: 1; width: 100%; }
        
        /* FEEDBACK UI - Minimalist visual debug (hidden in pocket) */
        #status-led { position: fixed; top: 10px; right: 10px; width: 8px; height: 8px; background: #333; border-radius: 50%; z-index: 5; pointer-events: none; transition: background 0.3s; }
        
        /* PANIC UI - Calculator */
        #p-layer { display: none; background: #000; height: 100%; flex-direction: column; z-index: 20; position: relative; padding: 20px; }
        #screen { 
            font-size: 4rem; color: #fff; text-align: right; padding: 40px 20px; 
            font-weight: 300; letter-spacing: -2px; border-bottom: 1px solid #333; margin-bottom: 20px; 
        }
        .keypad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; flex: 1; }
        .k-btn { 
            background: #333; border: none; color: white; font-size: 2rem; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; aspect-ratio: 1; cursor: pointer;
        }
        .k-btn:active { background: #555; }
        .op { background: #fe9f09; color: #000; font-weight: bold; }
        .mod { background: #a5a5a5; color: #000; }
    </style>
</head>
<body>

<div id="status-led"></div>

<div id="c-layer">
    <div id="z-top" class="zone"></div>
    <div id="z-bot" class="zone"></div>
</div>

<div id="p-layer">
    <div id="screen">0</div>
    <div class="keypad" id="calc">
        <button class="k-btn mod">AC</button><button class="k-btn mod">+/-</button><button class="k-btn mod">%</button><button class="k-btn op">รท</button>
        <button class="k-btn">7</button><button class="k-btn">8</button><button class="k-btn">9</button><button class="k-btn op">ร</button>
        <button class="k-btn">4</button><button class="k-btn">5</button><button class="k-btn">6</button><button class="k-btn op">-</button>
        <button class="k-btn">1</button><button class="k-btn">2</button><button class="k-btn">3</button><button class="k-btn op">+</button>
        <button class="k-btn" style="grid-column: span 2; border-radius: 40px;">0</button><button class="k-btn">.</button><button class="k-btn op" id="eq">=</button>
    </div>
</div>

<script>
/**
 * PRO MODE CONTROLLER v2.0
 * Modules: Audio, Haptic, Sensor, Chess, UI
 */

// --- CONFIGURATION ---
const CONFIG = {
    voiceSpeed: 1.8,   // 1.0 = Normal, 2.0 = Very Fast
    tapDelay: 600,     // Time to wait before speaking coordinate
    panicCode: "999",  // Code to unlock stealth
    holdTime: 500      // ms to register a hold vs a tap
};

// --- GLOBAL STATE ---
const state = {
    game: new Chess(),
    color: 'w',
    started: false,
    muted: true, // Start muted for safety
    from: null,
    l: 0, // Letter index (0-7)
    n: 0, // Number index (0-7)
    pattern: "",
    panic: false
};

// --- AUDIO ENGINE ---
const AudioEngine = {
    synth: window.speechSynthesis,
    timer: null,
    
    speak(text, immediate = false) {
        if (state.panic || state.muted) return;
        
        // Haptic "Earcon" (Tiny tick to confirm system heard you)
        Haptic.pulse('tick');

        // Cancel pending speech to prevent pile-up
        this.synth.cancel();
        clearTimeout(this.timer);

        const run = () => {
            const u = new SpeechSynthesisUtterance(text);
            u.rate = CONFIG.voiceSpeed;
            u.pitch = 0.9; // Slightly deeper is harder to hear from distance
            this.synth.speak(u);
        };

        if (immediate) run();
        else this.timer = setTimeout(run, CONFIG.tapDelay);
    },
    
    stop() {
        this.synth.cancel();
    }
};

// --- HAPTIC ENGINE ---
const Haptic = {
    pulse(type) {
        if (!navigator.vibrate) return;
        switch(type) {
            case 'tick': navigator.vibrate(10); break;          // Selection
            case 'lock': navigator.vibrate(30); break;          // Hold/Confirm
            case 'error': navigator.vibrate([50, 50, 50]); break; // Invalid
            case 'win': navigator.vibrate(600); break;          // Winning
            case 'loss': navigator.vibrate([100, 50, 100, 50, 100]); break; // Losing
            case 'active': navigator.vibrate([20, 50, 20]); break; // System Ready
        }
    }
};

// --- SENSOR FUSION (Pocket Detection) ---
const Sensor = {
    init() {
        // 1. Ambient Light (Chrome/Android)
        if ('AmbientLightSensor' in window) {
            try {
                const als = new AmbientLightSensor();
                als.onreading = () => {
                    // > 20 lux means it's definitely out of pocket
                    if (als.illuminance > 20) this.muteSystem();
                    else this.unmuteSystem();
                };
                als.start();
            } catch(e) { console.log("ALS not supported"); }
        }
    },
    
    muteSystem() {
        if (state.muted) return;
        state.muted = true;
        AudioEngine.stop();
        document.getElementById('status-led').style.background = '#333'; // Off
    },
    
    unmuteSystem() {
        if (!state.muted) return;
        state.muted = false;
        Haptic.pulse('active'); // Silent confirm we are back
        document.getElementById('status-led').style.background = '#0f0'; // Green
    },
    
    forceWake() {
        this.unmuteSystem();
        AudioEngine.speak("Active", true);
    }
};

// --- CLOUD BRAIN (Engine) ---
async function fetchMove(fen, detailed = false) {
    try {
        const res = await fetch('https://chess-api.com/v1', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ fen: fen })
        });
        const data = await res.json();
        
        if (detailed) {
            // Haptic Score
            if (data.eval > 1.5) Haptic.pulse('win');
            else if (data.eval < -1.5) Haptic.pulse('loss');
            else Haptic.pulse('lock'); // Neutral

            // Clean logic string
            const logic = data.text ? data.text.split('.')[0] : "";
            AudioEngine.speak(`${data.san}. ${data.eval}. ${logic}`, true);
        } else {
            AudioEngine.speak(data.san, true);
        }
    } catch (e) {
        AudioEngine.speak("Err", true);
    }
}

// --- LOGIC CORE ---
function handleInput(zone, type) {
    if (state.panic) return;

    // PATTERN DETECTION (ULUL)
    state.pattern += (zone === 'top' ? 'U' : 'L');
    setTimeout(() => state.pattern = state.pattern.slice(1), 1500);
    if (state.pattern.includes('ULUL')) { panicMode(true); return; }

    // WAKE GESTURE (Double Tap Top)
    if (zone === 'top' && type === 'tap' && state.muted) {
        Sensor.forceWake();
        return;
    }

    if (!state.started) {
        if (type === 'hold') {
            state.started = true;
            state.color = (zone === 'top') ? 'w' : 'b';
            AudioEngine.speak(state.color === 'w' ? "White" : "Black", true);
            if (state.color === 'b') fetchMove(state.game.fen());
        }
        return;
    }

    if (type === 'tap') {
        // Cycle Coordinates
        if (zone === 'top') {
            state.n = (state.n + 1) % 8;
            AudioEngine.speak(state.n + 1);
        } else {
            state.l = (state.l + 1) % 8;
            AudioEngine.speak("abcdefgh"[state.l]);
        }
    } else if (type === 'hold') {
        Haptic.pulse('lock');
        
        // Select From / Confirm Move
        const coord = "abcdefgh"[state.l] + (state.n + 1);
        
        if (zone === 'bot') {
            // Lock Source
            state.from = coord;
            AudioEngine.speak(coord, true);
        } else {
            // Execute Move
            if (state.from) {
                const move = state.game.move({ from: state.from, to: coord, promotion: 'q' });
                if (move) {
                    AudioEngine.speak(move.san, true);
                    state.from = null;
                    fetchMove(state.game.fen());
                } else {
                    Haptic.pulse('error');
                    AudioEngine.speak("No", true);
                }
            } else {
                // Undo
                state.game.undo();
                AudioEngine.speak("Undo", true);
            }
        }
    }
}

// --- TOUCH HANDLER ---
const setupTouch = (id, zone) => {
    const el = document.getElementById(id);
    let timer;
    
    el.addEventListener('touchstart', (e) => {
        e.preventDefault();
        timer = setTimeout(() => {
            timer = null;
            handleInput(zone, 'hold');
        }, CONFIG.holdTime);
    });
    
    el.addEventListener('touchend', (e) => {
        e.preventDefault();
        if (timer) {
            clearTimeout(timer);
            handleInput(zone, 'tap');
        }
    });
};

setupTouch('z-top', 'top');
setupTouch('z-bot', 'bot');

// MULTI-TOUCH (Hold Both)
let touches = 0;
document.addEventListener('touchstart', (e) => {
    touches = e.touches.length;
    if (touches === 2 && state.started && !state.muted) {
        fetchMove(state.game.fen(), true);
    }
});

// --- PANIC SYSTEM ---
function panicMode(enable) {
    const ui = document.getElementById('c-layer');
    const panic = document.getElementById('p-layer');
    state.panic = enable;
    
    if (enable) {
        ui.style.display = 'none';
        panic.style.display = 'flex';
        AudioEngine.stop();
        document.title = "Calculator";
    } else {
        ui.style.display = 'flex';
        panic.style.display = 'none';
        document.title = "Toolbox";
        Haptic.pulse('active');
    }
}

// Calculator Logic
let calcVal = "0";
document.getElementById('calc').addEventListener('click', (e) => {
    if (!e.target.classList.contains('k-btn')) return;
    const key = e.target.innerText;
    
    if (key === 'AC') calcVal = "0";
    else if (key === '=') {
        if (calcVal === CONFIG.panicCode) panicMode(false);
        calcVal = "0";
    }
    else {
        if (calcVal === "0") calcVal = key;
        else calcVal += key;
    }
    document.getElementById('screen').innerText = calcVal;
});

// INITIALIZE
Sensor.init();
AudioEngine.speak("System Ready", true);

</script>
</body>
</html>
