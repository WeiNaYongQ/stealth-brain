<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        body { margin: 0; background: #000; height: 100vh; overflow: hidden; touch-action: none; font-family: sans-serif; }
        #c-layer { display: flex; flex-direction: column; height: 100%; width: 100%; position: absolute; z-index: 10; opacity: 0.01; } 
        .zone { flex: 1; width: 100%; }
        #status-led { position: fixed; top: 10px; right: 10px; width: 8px; height: 8px; background: #222; border-radius: 50%; z-index: 5; }
        #p-layer { display: none; background: #000; height: 100%; flex-direction: column; z-index: 20; padding: 20px; }
        #screen { font-size: 4rem; color: #fff; text-align: right; padding: 40px 20px; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .keypad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; flex: 1; }
        .k-btn { background: #333; border: none; color: white; font-size: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; aspect-ratio: 1; }
        .op { background: #fe9f09; color: #000; }
    </style>
</head>
<body>

<div id="status-led"></div>
<div id="c-layer"><div id="z-top" class="zone"></div><div id="z-bot" class="zone"></div></div>

<div id="p-layer">
    <div id="screen">0</div>
    <div class="keypad" id="calc">
        <button class="k-btn">7</button><button class="k-btn">8</button><button class="k-btn">9</button><button class="k-btn op">รท</button>
        <button class="k-btn">4</button><button class="k-btn">5</button><button class="k-btn">6</button><button class="k-btn op">ร</button>
        <button class="k-btn">1</button><button class="k-btn">2</button><button class="k-btn">3</button><button class="k-btn op">-</button>
        <button class="k-btn" style="grid-column: span 2; border-radius: 40px;">0</button><button class="k-btn">.</button><button class="k-btn op">=</button>
    </div>
</div>

<script>
const CONFIG = { speed: 1.9, delay: 550, panic: "999" };
const state = { game: new Chess(), started: false, muted: true, from: null, l: 0, n: 0, pattern: "", panic: false };

// --- ENGINE SYSTEM (ONLINE + OFFLINE) ---
const Engine = {
    worker: null,
    isOfflineReady: false,

    init() {
        // Load Stockfish Worker from CDN (Browser will cache this for offline use)
        try {
            this.worker = new Worker('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');
            this.worker.onmessage = (e) => {
                if (e.data.startsWith('bestmove')) {
                    const moveRaw = e.data.split(' ')[1];
                    const move = state.game.move({ from: moveRaw.slice(0,2), to: moveRaw.slice(2,4), promotion: 'q' });
                    state.game.undo(); // Just testing the move
                    this.announce(move ? move.san : moveRaw, "Local");
                }
            };
            this.worker.postMessage('uci');
            this.isOfflineReady = true;
        } catch(e) { console.error("Offline Engine failed to load"); }
    },

    async getMove(fen) {
        // Strategy: Try Cloud, Fallback to Local Worker
        if (navigator.onLine) {
            try {
                const res = await fetch('https://chess-api.com/v1', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ fen })
                });
                const data = await res.json();
                this.announce(data.san, "");
                return;
            } catch (e) { /* Fall through to local */ }
        }
        
        if (this.isOfflineReady) {
            this.worker.postMessage('position fen ' + fen);
            this.worker.postMessage('go depth 12'); // Fast depth for offline
        }
    },

    announce(move, source) {
        Audio.speak(move + " " + source, true);
    }
};

// --- AUDIO & HAPTICS ---
const Audio = {
    synth: window.speechSynthesis,
    speak(txt, now = false) {
        if (state.panic || state.muted) return;
        this.synth.cancel();
        const u = new SpeechSynthesisUtterance(txt);
        u.rate = CONFIG.speed;
        if (now) this.synth.speak(u);
        else setTimeout(() => this.synth.speak(u), CONFIG.delay);
    }
};

const Haptic = {
    v(ms) { if(navigator.vibrate) navigator.vibrate(ms); }
};

// --- POCKET SENSOR ---
if ('AmbientLightSensor' in window) {
    const sensor = new AmbientLightSensor();
    sensor.onreading = () => {
        if (sensor.illuminance > 15) { 
            state.muted = true; 
            Audio.synth.cancel(); 
            document.getElementById('status-led').style.background = '#222';
        } else {
            state.muted = false;
            document.getElementById('status-led').style.background = '#0f0';
        }
    };
    sensor.start();
}

// --- INPUT LOGIC ---
function handle(zone, type) {
    if (state.panic) return;
    
    // ULUL Pattern for Panic
    state.pattern += (zone === 'top' ? 'U' : 'L');
    if (state.pattern.endsWith('ULUL')) { togglePanic(true); return; }

    // Wake up if muted
    if (zone === 'top' && type === 'tap' && state.muted) {
        state.muted = false;
        Haptic.v(50);
        Audio.speak("Active", true);
        return;
    }

    if (!state.started && type === 'hold') {
        state.started = true;
        Audio.speak("Start", true);
        if (zone === 'bot') Engine.getMove(state.game.fen());
        return;
    }

    if (type === 'tap') {
        if (zone === 'top') { state.n = (state.n + 1) % 8; Audio.speak(state.n + 1); }
        else { state.l = (state.l + 1) % 8; Audio.speak("abcdefgh"[state.l]); }
    } else {
        Haptic.v(30);
        const sq = "abcdefgh"[state.l] + (state.n + 1);
        if (zone === 'bot') { state.from = sq; Audio.speak(sq, true); }
        else {
            if (state.from) {
                const m = state.game.move({ from: state.from, to: sq, promotion: 'q' });
                if (m) { Audio.speak(m.san, true); state.from = null; Engine.getMove(state.game.fen()); }
                else { Audio.speak("Error", true); Haptic.v([50, 50]); }
            } else { state.game.undo(); Audio.speak("Undo", true); }
        }
    }
}

// --- SETUP ---
const bind = (id, zone) => {
    let t;
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => { 
        e.preventDefault(); 
        t = setTimeout(() => { t = null; handle(zone, 'hold'); }, 500); 
    });
    el.addEventListener('touchend', (e) => { 
        e.preventDefault(); 
        if (t) { clearTimeout(t); handle(zone, 'tap'); } 
    });
};
bind('z-top', 'top'); bind('z-bot', 'bot');

function togglePanic(on) {
    state.panic = on;
    document.getElementById('c-layer').style.display = on ? 'none' : 'flex';
    document.getElementById('p-layer').style.display = on ? 'flex' : 'none';
}

let cv = "0";
document.getElementById('calc').addEventListener('click', (e) => {
    const k = e.target.innerText;
    if (k === '=') { if (cv === CONFIG.panic) togglePanic(false); cv = "0"; }
    else cv = (cv === "0" ? k : cv + k);
    document.getElementById('screen').innerText = cv;
});

Engine.init();
</script>
</body>
</html>
